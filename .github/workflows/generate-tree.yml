name: Generate tree-data.json

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build_tree:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Generate tree-data.json (hierarchical)
        shell: bash
        run: |
          echo "開始建立樹狀 JSON..."

          generate_tree() {
            local dir="$1"
            local indent="$2"

            echo "${indent}{"
            echo "${indent}  \"title\": \"$(basename "$dir")\","
            echo "${indent}  \"path\": \"$dir/\","
            echo "${indent}  \"children\": ["

            shopt -s nullglob

            local first=1

            # 子資料夾
            for subdir in "$dir"/*/ ; do
              local d=$(basename "$subdir")
              # 跳過 .github
              if [[ "$d" == ".github" ]]; then
                continue
              fi

              if [[ $first -eq 0 ]]; then echo "${indent},"; fi
              generate_tree "$dir/$d" "  $indent"
              first=0
            done

            # HTML 檔案
            for file in "$dir"/*.html ; do
              if [[ -f "$file" ]]; then
                local f=$(basename "$file")

                if [[ $first -eq 0 ]]; then echo "${indent},"; fi
                echo "${indent}  { \"title\": \"$f\", \"path\": \"$file\" }"
                first=0
              fi
            done

            echo ""
            echo "${indent}  ]"
            echo "${indent}}"
          }

          echo "[" > tree-data.json

          first_dir=1
          for dir in */ ; do
            dirname="${dir%/}"
            if [[ "$dirname" == ".github" ]]; then
              continue
            fi

            if [[ $first_dir -eq 0 ]]; then
              echo "," >> tree-data.json
            fi

            generate_tree "$dirname" "" >> tree-data.json
            first_dir=0
          done

          echo "]" >> tree-data.json

      - name: Commit tree-data.json
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto-update tree-data.json"
          file_pattern: "tree-data.json"
