name: Generate tree-data.json

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-tree:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate tree-data.json
        run: |
          python << 'PY'
          import os, json

          ROOT = "."
          EXCLUDE_DIRS = {".git", ".github", ".vscode", "__pycache__"}
          EXCLUDE_FILES = {"tree-data.json"}

          def build_tree(path):
              items = []
              for name in sorted(os.listdir(path)):
                  # 可視需要調整：隱藏檔案先全部略過
                  if name.startswith("."):
                      if name not in EXCLUDE_DIRS:
                          continue

                  full = os.path.join(path, name)
                  rel = os.path.relpath(full, ROOT).replace(os.sep, "/")

                  if os.path.isdir(full):
                      if name in EXCLUDE_DIRS:
                          continue
                      items.append({
                          "title": name,
                          "path": rel + "/",
                          "isFolder": True,
                          "children": build_tree(full)
                      })
                  else:
                      if name in EXCLUDE_FILES:
                          continue
                      items.append({
                          "title": name,
                          "path": rel,
                          "isFolder": False
                      })
              return items

          tree = build_tree(ROOT)

          with open("tree-data.json", "w", encoding="utf-8") as f:
              json.dump(tree, f, ensure_ascii=False, indent=2)

          print("tree-data.json generated with", len(tree), "top-level items.")
          PY

      - name: Commit and push tree-data.json
        run: |
          if git status --porcelain tree-data.json | grep -q .; then
            echo "Changes detected in tree-data.json, committing..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add tree-data.json
            git commit -m "chore: update tree-data.json"
            git push
          else
            echo "No changes in tree-data.json"
          fi
