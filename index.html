<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GOLDENWAY 官網備份平台</title>

  <!-- 字體：Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <!-- 圖標庫：Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root {
      /* [調整重點 1] 玻璃質感變數 - 讓質感更明顯 */
      /* 稍微調高不透明度 (0.3 -> 0.75)，讓它看起來更像實體的「毛玻璃板」，而不只是透明塑膠 */
      --glass-bg: rgba(255, 255, 255, 0.55);      
      
      /* 邊框調亮，增加邊緣反光感 */
      --glass-border: rgba(255, 255, 255, 0.6);   
      
      /* 模糊度維持，確保背景圖片不會干擾文字 */
      --glass-blur: blur(20px) saturate(180%);   /* 加入 saturate 增加鮮豔度 */
      
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
      
      --primary: #0071e3;
      --primary-light: rgba(0, 113, 227, 0.15); 
      
      --text-main: #1f2937;
      --text-sub: #555555; 
      
      --sidebar-w: 280px;
      --header-h: 60px;
      
      --radius-lg: 16px; 
      --radius-md: 8px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      color: var(--text-main);
      
      /* ───── [調整重點 2] 背景圖片設定 ───── */
      /* 請將 url(...) 括號內的網址換成您喜歡的圖片連結 */
      /* 這裡先放一張範例風景圖 */
      background-image: url('https://images.unsplash.com/photo-1515338580809-319aaaae76fd?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      
      /* 讓圖片填滿整個螢幕且不重複 */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ───── Top Bar (Header - Glass) ───── */
    .topbar {
      height: var(--header-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
      
      /* 玻璃擬態樣式 */
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-bottom: 1px solid var(--glass-border);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .left-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-btn {
      display: none; 
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }
    .menu-btn:active { background: rgba(0,0,0,0.05); }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      /* background: #111;  <-- 如果您的 Logo 是透明背景，可以保留這個黑色底色，或是改成 transparent (透明) */
      background: transparent; 
      display: flex;
      align-items: center;
      justify-content: center;
      /* color: white; <-- 這是給 icon 用的，用圖片就不需要了 */
      overflow: hidden;
      /* box-shadow: 0 2px 5px rgba(0,0,0,0.1); */
    }
    
    .brand-logo img { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; /* 確保 logo 完整顯示，不被裁切 */
    }

    .brand-info h1 {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
      letter-spacing: 0.5px;
    }
    
    .brand-info span {
      font-size: 11px;
      color: var(--text-sub);
      display: block;
    }

    /* ───── Search ───── */
    .search-container {
      position: relative;
      width: 280px;
    }

    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      color: var(--text-sub);
      font-size: 16px;
    }

    .search-input {
      width: 100%;
      padding: 7px 10px 7px 32px;
      border-radius: 99px;
      /* 搜尋框要在玻璃上清楚，需要更白一點 */
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.4);
      font-size: 13px;
      color: var(--text-main);
      transition: all 0.2s ease;
      outline: none;
    }

    .search-input:focus {
      background: rgba(255, 255, 255, 0.95);
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
    }

    .search-clear {
      position: absolute;
      right: 10px;
      cursor: pointer;
      color: var(--text-sub);
      font-size: 14px;
      display: none;
    }
    .search-clear.visible { display: block; }

    /* ───── Main Layout ───── */
    .body-layout {
      display: flex;
      flex: 1;
      height: calc(100vh - var(--header-h));
      position: relative;
    }

    /* ───── Sidebar (Glass) ───── */
    .sidebar {
      width: var(--sidebar-w);
      
      /* 玻璃擬態樣式 */
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-right: 1px solid var(--glass-border);
      
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .sidebar-tools {
      padding: 10px 14px;
      border-bottom: 1px solid var(--glass-border); 
      display: flex;
      gap: 6px;
    }

    .icon-btn {
      background: rgba(255,255,255,0.4);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 6px;
      padding: 5px 8px;
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.1s;
    }
    
    .icon-btn:hover { background: rgba(255,255,255,0.8); }

    .icon-btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .icon-btn.primary:hover { background: #0062c4; }

    .tree-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    /* 樹狀選單樣式 */
    ul { list-style: none; padding-left: 0; margin: 0; }
    .tree-node { position: relative; }

    .node-content {
      display: flex;
      align-items: center;
      padding: 5px 14px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-main);
      border-left: 3px solid transparent;
      gap: 8px;
      user-select: none;
      transition: background 0.2s;
    }

    .node-content:hover { 
      background: rgba(255,255,255,0.4);
    }

    .caret {
      font-size: 10px; color: var(--text-sub); width: 12px;
      display: flex; justify-content: center; transition: transform 0.2s;
    }
    
    .folder-icon { color: #fbbf24; font-size: 16px; }
    .file-icon { color: var(--text-sub); font-size: 16px; }

    .folder.open > .node-content .caret { transform: rotate(90deg); }
    
    .sub-tree { display: none; padding-left: 20px; position: relative; }
    .sub-tree::before {
      content: ""; position: absolute; top: 0; bottom: 0; left: 11px;
      width: 1px; background: rgba(0,0,0,0.1); 
    }
    .folder.open > .sub-tree { display: block; }

    .file.active .node-content {
      background: var(--primary-light);
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 500;
      backdrop-filter: blur(5px); 
    }
    .file.active .file-icon { color: var(--primary); }

    .mobile-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4); /* 背景圖片較雜時，遮罩可以稍微深一點 */
      z-index: 20; 
      backdrop-filter: blur(4px); 
      opacity: 0;
      transition: opacity 0.3s;
    }
    .mobile-overlay.show { opacity: 1; }

    /* ───── Main Content Area ───── */
    .main-content {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 48px; 
    }

    /* ───── Preview Window Card (Glass) ───── */
    .preview-window {
      flex: 1;
      border-radius: var(--radius-lg);
      
      /* [調整重點 3] 預覽視窗外框 */
      /* 這裡可以稍微透一點 (0.6)，讓裡面的白色 iframe 跟外部背景有層次 */
      background: rgba(255, 255, 255, 0.6);  
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .window-header {
      height: 40px;
      background: rgba(255, 255, 255, 0.3); 
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 16px;
      flex-shrink: 0;
    }

    .window-dots { display: flex; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .dot.red { background: #ff5f57; border: 1px solid rgba(0,0,0,0.05); }
    .dot.yellow { background: #febc2e; border: 1px solid rgba(0,0,0,0.05); }
    .dot.green { background: #28c840; border: 1px solid rgba(0,0,0,0.05); }

    .window-title-bar {
      flex: 1;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 6px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-sub);
      max-width: 400px;
      margin: 0 auto;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      padding: 0 8px;
    }
    .window-actions { width: 40px; }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white; 
      display: block;
    }

    /* ───── Hero (Glass) ───── */
    .hero {
      position: absolute;
      inset: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      
      border-radius: var(--radius-lg);
      box-shadow: var(--glass-shadow);
      
      /* 修改：加入淡入動畫 */
      /* 使用相同的 fadeIn 動畫，但稍微調慢一點 (0.6s) 讓它看起來更悠閒 */
      animation: fadeIn 1s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* [重點調整] Hero Icon - 乾淨線框風格 */
    .hero-icon {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      
      /* 1. 移除所有背景色和模糊，只留純淨外框 */
      background: transparent; 
      backdrop-filter: none;
      
      /* 2. 白色線框 */
      border: 2px solid rgba(65, 131, 193, 0.65); 
      border-radius: 28px; 
      
      /* 3. 初始光暈：微弱的藍紫色 (Blue-Purple) */
      box-shadow: 
        0 0 10px rgba(255, 255, 255, 0.2), /* 基礎白光 */
        0 0 20px rgba(80, 80, 255, 0.4);   /* 藍紫光暈 */
        
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden; 
      padding: 15px;
      
      transition: box-shadow 0.6s ease, border-color 0.6s ease;
      cursor: default; 
    }
    
    /* [重點調整] 懸停效果 - 只有光暈變化，無位移 */
    .hero-icon:hover {
      /* 移除 transform，保持圖示靜止 */
      transform: none; 
      border-color: #4183c1;
      
      /* 懸停光暈：變為「藍粉色 (Blue-Pink)」且範圍變大 */
      box-shadow: 
        0 0 15px rgba(255, 255, 255, 0.3),  /* 增強內層白光 */
        0 0 30px rgba(0, 190, 255, 0.7),    /* 中層：亮藍色 */
        0 0 60px rgba(255, 100, 200, 0.6);  /* 外層：柔和粉色 */
    }
    
    .hero-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* 移除圖片本身的縮放動畫 */
      transition: none;
    }
    
    .hero-icon:hover img {
      /* 移除 hover 時的圖片放大 */
      transform: none;
    }

    .hero h2 {
      font-size: 22px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: var(--text-main);
    }

    .hero p {
      color: var(--text-sub);
      font-size: 14px;
      max-width: 380px;
      line-height: 1.6;
    }

    .hidden { display: none !important; }

    /* ───── Search Results ───── */
    #searchResults { padding: 10px; display: none; }
    .search-result-item {
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      border: 1px solid transparent;
      background: rgba(255,255,255,0.4); 
    }
    .search-result-item:hover {
      background: rgba(255,255,255,0.85);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .res-title { font-size: 13px; font-weight: 500; color: var(--primary); }
    .res-path { font-size: 11px; color: var(--text-sub); margin-top: 1px; }

    /* Responsive */
    @media (max-width: 768px) {
      .menu-btn { display: block; }
      
      .main-content { padding: 16px; } 
      .hero { inset: 16px; }
      
      .preview-window { border-radius: var(--radius-md); border: 1px solid var(--glass-border); }
      .window-header { display: none; }

      .sidebar { 
        position: absolute; 
        height: 100%; 
        z-index: 30; 
        transform: translateX(-100%); 
        box-shadow: 10px 0 25px rgba(0,0,0,0.2); 
        /* 手機版不透明度要高一點，保證易讀性 */
        background: rgba(255, 255, 255, 0.9); 
      }
      .sidebar.open { transform: translateX(0); }
      
      .mobile-overlay.show { display: block; }

      .search-container { width: auto; flex: 1; }
      .brand-info { display: none; }
    }
  </style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="topbar">
    <div class="left-section">
      <!-- 漢堡選單按鈕 (手機版專用) -->
      <button id="menuToggleBtn" class="menu-btn">
        <i class="ph-bold ph-list"></i>
      </button>

      <div class="brand">
        <div class="brand-logo">
          <!-- [修改] 替換成 Logo 圖片，請將 src 換成您自己的圖片網址 -->
          <!-- 這裡我先用一個暫位圖示範 -->
          <img src="https://cdn.jsdelivr.net/gh/TsenWu/goldenway-photos/GW.png" alt="Logo" />
        </div>
        <div class="brand-info">
          <h1>金鍏電子【GoldenWay】</h1>
          <span>備份及預覽平台</span>
        </div>
      </div>
    </div>

    <div class="search-container">
      <div class="search-wrapper">
        <i class="ph ph-magnifying-glass search-icon"></i>
        <input class="search-input" id="searchInput" type="text" placeholder="搜尋檔案..." />
        <i class="ph-bold ph-x search-clear" id="searchClear"></i>
      </div>
    </div>
  </header>

  <div class="body-layout">
    <!-- 手機版遮罩 (Overlay) -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-tools">
        <button id="homeBtn" class="icon-btn primary">
          <i class="ph-bold ph-house"></i> 首頁
        </button>
        <button id="expandBtn" class="icon-btn" title="展開">
          <i class="ph-bold ph-list-dashes"></i>
        </button>
        <button id="collapseBtn" class="icon-btn" title="收合">
          <i class="ph-bold ph-arrows-in-line-vertical"></i>
        </button>
      </div>

      <div class="tree-container">
        <div id="treeRoot"></div>
        <div id="searchResults"></div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Empty State / Hero -->
      <div id="hero" class="hero">
        <div class="hero-icon">
          <!-- [修改] 替換成 Logo 圖片，請將 src 換成您自己的圖片網址 -->
          <!-- 建議這裡可以使用較高解析度的 Logo -->
          <img src="https://cdn.jsdelivr.net/gh/TsenWu/goldenway-photos/GW.png" alt="Big Logo" />
        </div>
        <h2>金鍏電子【GoldenWay】</h2>
        <p>─ 歡迎使用備份預覽系統 ─<br>已載入完整目錄列表，請從列表選擇預覽</p>
      </div>

      <!-- Preview Window (Card Style) -->
      <div id="previewContainer" class="preview-window">
        <!-- 模擬視窗標題列 -->
        <div class="window-header">
          <div class="window-dots">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
          </div>
          <div class="window-title-bar">
            <i class="ph-fill ph-lock-key" style="font-size:10px; margin-right:4px;"></i>
            <span id="previewTitleText">preview.html</span>
          </div>
          <div class="window-actions"></div>
        </div>
        
        <iframe id="previewFrame" title="Preview"></iframe>
      </div>
    </main>
  </div>
</div>

<script>
  /* * 1. 手機版選單邏輯 */
  const menuToggleBtn = document.getElementById("menuToggleBtn");
  const sidebar = document.getElementById("sidebar");
  const mobileOverlay = document.getElementById("mobileOverlay");

  function toggleSidebar() {
    const isOpen = sidebar.classList.contains("open");
    if (isOpen) {
      sidebar.classList.remove("open");
      mobileOverlay.classList.remove("show");
      setTimeout(() => mobileOverlay.style.display = 'none', 300); 
    } else {
      sidebar.classList.add("open");
      mobileOverlay.style.display = 'block';
      mobileOverlay.offsetHeight; 
      mobileOverlay.classList.add("show");
    }
  }

  menuToggleBtn.onclick = toggleSidebar;
  mobileOverlay.onclick = toggleSidebar;

  /* * 2. 數據與清洗邏輯 */
  let treeData = [];
  let fileIndex = [];
  let isDemoMode = false;

  function formatTitle(title) {
    if (!title) return "";
    return title.replace(/\.html$/i, "").replace(/【|】/g, "").trim();
  }

  const REAL_DATA_FALLBACK = [
  {
    "title": "about",
    "children": [
      { "title": "【溫室氣體盤查報告書】.html", "path": "about/【溫室氣體盤查報告書】.html" },
      { "title": "光板燈介紹.html", "path": "about/光板燈介紹.html" },
      { "title": "專利認證.html", "path": "about/專利認證.html" },
      { "title": "營運架構.html", "path": "about/營運架構.html" },
      { "title": "節能減碳最佳方案-LED光板型燈具.html", "path": "about/節能減碳最佳方案-LED光板型燈具.html" }
    ]
  },
  {
    "title": "施工安裝", 
    "children": [
         { "title": "保固維修與退換貨.html", "path": "product/施工安裝與售後服務/保固維修與退換貨.html" },
         { "title": "施工人員出車費.html", "path": "product/施工安裝與售後服務/施工人員出車費.html" }
    ]
  },
  {
    "title": "product",
    "children": [
      {
        "title": "吸頂式燈具",
        "children": [
          { "title": "山型光板燈 BL-370", "children": [
              { "title": "燈具介紹.html", "path": "product/吸頂式燈具/山型光板燈 BL-370/燈具介紹.html" },
              { "title": "詳細規格.html", "path": "product/吸頂式燈具/山型光板燈 BL-370/詳細規格.html" }
            ]
          },
          { "title": "山型光板燈 BL-380", "children": [
              { "title": "燈具介紹.html", "path": "product/吸頂式燈具/山型光板燈 BL-380/燈具介紹.html" }
            ]
          },
          { "title": "感應燈 CL-201", "children": [
              { "title": "燈具介紹.html", "path": "product/吸頂式燈具/感應燈 CL-201/燈具介紹.html" }
            ]
          }
        ]
      },
      {
        "title": "嵌入式燈具",
        "children": [
          { "title": "商辦用燈 OL-747", "children": [
              { "title": "燈具介紹.html", "path": "product/嵌入式燈具/商辦用燈 OL-747/燈具介紹.html" }
            ]
          },
          { "title": "小型嵌燈 DL-320", "children": [
               { "title": "燈具介紹.html", "path": "product/嵌入式燈具/小型嵌燈 DL-320/燈具介紹.html" }
            ]
          }
        ]
      },
      {
        "title": "投光燈燈具",
        "children": [
           { "title": "投光燈 FL-618", "children": [
               { "title": "燈具介紹.html", "path": "product/投光燈燈具/投光燈 FL-618/燈具介紹.html" }
             ] 
           }
        ]
      },
      {
        "title": "高天井燈具",
        "children": [
           { "title": "高天井燈 HBL-606", "children": [
               { "title": "燈具介紹.html", "path": "product/高天井燈具/高天井燈 HBL-606/燈具介紹.html" }
             ] 
           }
        ]
      },
      {
        "title": "特殊應用型",
        "children": [
           { "title": "路燈燈具 RL-406", "children": [
               { "title": "燈具介紹.html", "path": "product/特殊應用型/路燈燈具 RL-406/燈具介紹.html" }
             ] 
           }
        ]
      }
    ]
  },
  {
    "title": "shared",
    "children": [
      { "title": "視覺化圖表", "children": [
         { "title": "平板燈5年總持有成本比較表.html", "path": "shared/視覺化圖表/平板燈5年總持有成本比較表.html" }
      ]}
    ]
  }
];

  async function initApp() {
    try {
      const res = await fetch("tree-data.json");
      if (!res.ok) throw new Error("File not found");
      const data = await res.json();
      startApp(data);
    } catch (err) {
      console.warn("切換至預覽模式", err);
      isDemoMode = true;
      startApp(REAL_DATA_FALLBACK);
    }
  }

  function startApp(data) {
    treeData = data;
    buildIndex(data); 
    renderTree(data, document.getElementById("treeRoot"));
  }

  initApp();

  /* * 3. 樹狀結構渲染 */
  function renderTree(nodes, container) {
    const ul = document.createElement("ul");
    if(container.id !== "treeRoot") ul.className = "sub-tree";

    nodes.forEach(node => {
      const li = document.createElement("li");
      const isFolder = Array.isArray(node.children);
      const cleanName = formatTitle(node.title);

      if (isFolder) {
        li.className = "tree-node folder";
        const content = document.createElement("div");
        content.className = "node-content";
        content.innerHTML = `
          <i class="ph-bold ph-caret-right caret"></i>
          <i class="ph-fill ph-folder folder-icon"></i>
          <span>${cleanName}</span>
        `;
        content.onclick = (e) => {
          e.stopPropagation();
          li.classList.toggle("open");
        };
        li.appendChild(content);
        renderTree(node.children, li);
      } else if (node.path) {
        li.className = "tree-node file";
        const content = document.createElement("div");
        content.className = "node-content";
        content.innerHTML = `
          <div style="width:12px"></div>
          <i class="ph ph-file-html file-icon"></i>
          <span>${cleanName}</span>
        `;
        content.onclick = (e) => {
          e.stopPropagation();
          loadPreview(node.path, cleanName, li);
          if (window.innerWidth <= 768) {
            toggleSidebar();
          }
        };
        li.appendChild(content);
      }
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  /* * 4. 功能邏輯 */
  const hero = document.getElementById("hero");
  const previewContainer = document.getElementById("previewContainer"); 
  const frame = document.getElementById("previewFrame");
  const previewTitleText = document.getElementById("previewTitleText"); 
  
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");
  const treeRoot = document.getElementById("treeRoot");
  const searchClear = document.getElementById("searchClear");

  function loadPreview(path, title, activeLi) {
    hero.classList.add("hidden");
    previewContainer.style.display = "flex"; 
    
    previewTitleText.textContent = path;

    document.querySelectorAll(".file.active").forEach(el => el.classList.remove("active"));
    if (activeLi) activeLi.classList.add("active");

    if (isDemoMode) {
      const doc = frame.contentWindow.document;
      doc.open();
      doc.write(`
        <style>
          body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;color:#555;background:#fff;}
          .msg{padding:20px;text-align:center;}
          h2{color:#0071e3; margin-bottom: 8px;}
          p { margin: 4px 0; }
          .badge { display:inline-block; background:#f3f4f6; color:#666; padding:4px 8px; border-radius:4px; font-size:12px; margin-top:10px;}
        </style>
        <div class="msg">
          <h2>${title}</h2>
          <p>檔案路徑: ${path}</p>
          <div class="badge">此為預覽環境模擬畫面，部署至 GitHub 後將直接顯示真實網頁內容</div>
        </div>
      `);
      doc.close();
    } else {
      frame.src = path;
    }
  }

  document.getElementById("homeBtn").onclick = () => {
    hero.classList.remove("hidden");
    previewContainer.style.display = "none";
    frame.src = "";
    document.querySelectorAll(".file.active").forEach(el => el.classList.remove("active"));
    
    if (window.innerWidth <= 768 && sidebar.classList.contains("open")) {
        toggleSidebar();
    }
  };

  document.getElementById("expandBtn").onclick = () => {
    document.querySelectorAll(".folder").forEach(el => el.classList.add("open"));
  };

  document.getElementById("collapseBtn").onclick = () => {
    document.querySelectorAll(".folder").forEach(el => el.classList.remove("open"));
  };

  /* * 搜尋邏輯 */
  function buildIndex(nodes, pathStr = "") {
    nodes.forEach(node => {
      const cleanName = formatTitle(node.title);
      if (node.children) {
        buildIndex(node.children, pathStr + cleanName + " / ");
      } else if (node.path) {
        fileIndex.push({
          title: cleanName,
          originalTitle: node.title,
          path: node.path,
          fullPath: pathStr + cleanName
        });
      }
    });
  }

  searchInput.addEventListener("input", (e) => {
    const val = e.target.value.toLowerCase().trim();
    if (val.length > 0) {
      treeRoot.style.display = "none";
      searchResults.style.display = "block";
      searchClear.classList.add("visible");
      
      const hits = fileIndex.filter(f => 
        f.title.toLowerCase().includes(val) || 
        f.fullPath.toLowerCase().includes(val)
      );
      
      if (hits.length === 0) {
        searchResults.innerHTML = `<div style="text-align:center; color:#999; padding:20px; font-size:13px;">找不到符合的檔案</div>`;
      } else {
        searchResults.innerHTML = hits.map(hit => `
          <div class="search-result-item" onclick="loadPreview('${hit.path}', '${hit.title}', null)">
            <div class="res-title">${hit.title}</div>
            <div class="res-path">${hit.fullPath}</div>
          </div>
        `).join("");
      }
    } else {
      resetSearch();
    }
  });

  searchClear.onclick = () => {
    searchInput.value = "";
    resetSearch();
  };

  function resetSearch() {
    treeRoot.style.display = "block";
    searchResults.style.display = "none";
    searchClear.classList.remove("visible");
  }
</script>
</body>
</html>
